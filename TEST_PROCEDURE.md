# Link Canvas - VSCode 標準 API 統合 テスト手順書

**ブランチ**: `feat/vscode-context-menu-integration`
**実装概要**: VSCode 標準 API (`executeDefinitionProvider`, `executeReferenceProvider`) を使用して、エディタコンテキストメニューから定義・参照情報を Link Canvas キャンバスに表示

---

## テスト実行前のセットアップ

### 前提条件

- ✅ Node.js 16 以上
- ✅ VS Code 1.80.0 以上
- ✅ TypeScript/JavaScript プロジェクトが開かれていること

### ビルド確認

```bash
cd /Users/hirokimukai/Cloudprojects/link-canvas
npm run build
# 期待結果: "Build complete"
```

### デバッグ環境起動

1. VS Code で `/Users/hirokimukai/Cloudprojects/link-canvas` を開く
2. **F5** を押す（Run → Start Debugging）
3. 新しい VSCode ウィンドウが開く（Extension Development Host）
4. デバッグコンソールを表示（View → Debug Console）

---

## テスト 1: 定義取得機能 - 基本動作

**目的**: エディタコンテキストメニューから定義を取得できることを確認

### テスト手順

1. **テストファイルを準備**

   - 新しいウィンドウで `/Users/hirokimukai/Cloudprojects/link-canvas/src/extension.ts` を開く

2. **シンボルを選択**

   - `FileTreeProvider` という単語にカーソルを置く

3. **右クリック**

   - エディタを右クリック
   - コンテキストメニューを確認

4. **メニュー実行**

   - **「Show Definition in Canvas」** を選択

5. **動作確認**

### 期待結果

| 項目           | 期待値                                                                       |
| -------------- | ---------------------------------------------------------------------------- |
| メニュー表示   | エディタのコンテキストメニューに「Show Definition in Canvas」が表示される    |
| キャンバス表示 | Link Canvas パネルが自動的に開く                                             |
| ファイル表示   | `FileTreeProvider.ts` ファイルが新しいウィンドウとしてキャンバスに追加される |
| デバッグログ   | 以下のログが出力される                                                       |

**確認ログ例**:

```
[Link Canvas] showDefinitionコマンド実行
[Link Canvas] 定義表示開始: /Users/.../extension.ts Position: 7 18
[Link Canvas] 定義ファイルをキャンバスに追加: FileTreeProvider.ts
```

### ✅ テスト 1 成功条件

- [ ] コンテキストメニューに「Show Definition in Canvas」が表示される
- [ ] Link Canvas パネルが開く
- [ ] 定義ファイル（FileTreeProvider.ts）が表示される
- [ ] デバッグコンソールにログ出力がある
- [ ] エラーメッセージが出力されない

---

## テスト 2: 参照取得機能 - 複数参照

**目的**: 複数の参照を取得してすべてキャンバスに表示できることを確認

### テスト手順

1. **テストファイルを選択**

   - `/Users/hirokimukai/Cloudprojects/link-canvas/src/extension.ts` から
   - `canvasProvider` という単語にカーソルを置く

2. **右クリック**

   - **「Show References in Canvas」** を選択

3. **動作確認**

### 期待結果

| 項目           | 期待値                                                                    |
| -------------- | ------------------------------------------------------------------------- |
| メニュー実行   | 複数のファイルが同時にキャンバスに追加される                              |
| ウィンドウ数   | `canvasProvider` が使用されている箇所分のウィンドウが追加される（複数個） |
| ハイライト位置 | 各ウィンドウで異なる行がハイライトされる                                  |
| デバッグログ   | 参照数が出力される                                                        |

**確認ログ例**:

```
[Link Canvas] showReferencesコマンド実行
[Link Canvas] 参照表示開始: /Users/.../extension.ts Position: 8 25
[Link Canvas] 参照ファイルをキャンバスに追加: CanvasViewProvider.ts
[Link Canvas] 参照ファイルをキャンバスに追加: extension.ts
[Link Canvas] 参照ファイルをキャンバスに追加: ...（複数）
[Link Canvas] 参照数: 5
```

### ✅ テスト 2 成功条件

- [ ] 複数ファイルがキャンバスに追加される
- [ ] 各ファイルで異なる行がハイライトされている
- [ ] 参照数ログが正確に表示される
- [ ] エラーメッセージが出力されない

---

## テスト 3: エラーハンドリング - 定義なしケース

**目的**: 定義が見つからない場合のエラーハンドリングを確認

### テスト手順

1. **標準関数を選択**

   - VS Code エディタで `console` にカーソルを置く

2. **右クリック**

   - **「Show Definition in Canvas」** を選択

3. **ユーザーメッセージを確認**

### 期待結果

| 項目               | 期待値                                             |
| ------------------ | -------------------------------------------------- |
| ユーザーメッセージ | ポップアップで「定義が見つかりませんでした」と表示 |
| キャンバス         | 新しいウィンドウは追加されない                     |
| デバッグログ       | エラーメッセージではなく、情報通知のみ             |

**確認ログ例**:

```
[Link Canvas] showDefinitionコマンド実行
[Link Canvas] 定義表示開始: /Users/.../test.ts Position: X X
```

### ✅ テスト 3 成功条件

- [ ] ユーザーメッセージが表示される
- [ ] キャンバスに新しいウィンドウが追加されない
- [ ] クリティカルなエラーが出力されない

---

## テスト 4: Monaco Editor 表示 - ズーム機能

**目的**: ズームレベルに応じて Monaco Editor が表示され、ハイライトが反映されることを確認

### テスト手順

1. **テスト 1 でキャンバスに追加したウィンドウを確認**

   - ズームレベル < 1.0：ファイル名とクラス/関数一覧表示（プレビューモード）

2. **ズームイン操作**

   - キャンバス上で **Cmd/Ctrl + マウスホイール上** で拡大
   - または**Cmd/Ctrl + 数字キー +** で拡大

3. **ズームレベルが 1.0 以上になったことを確認**

4. **Monaco Editor の表示を確認**

### 期待結果

| 項目                   | 期待値                                   |
| ---------------------- | ---------------------------------------- |
| ズームレベル < 1.0     | ファイル名のみ（またはプレビューモード） |
| ズームレベル >= 1.0    | Monaco Editor でコード表示               |
| ハイライト反映         | 定義元の行がハイライトされている         |
| シンタックスハイライト | コードが言語別に色分けされている         |

### ✅ テスト 4 成功条件

- [ ] ズームイン時に Monaco Editor が表示される
- [ ] ハイライト行が視認できる
- [ ] シンタックスハイライトが適用されている

---

## テスト 5: 連続操作 - 複数定義追加

**目的**: 複数の定義/参照を連続して追加でき、キャンバスが正常に動作することを確認

### テスト手順

1. **定義取得**

   - ファイル 1 で`Class1`に右クリック → **「Show Definition in Canvas」**

2. **参照取得**

   - ファイル 2 で`function1`に右クリック → **「Show References in Canvas」**

3. **さらに定義取得**

   - ファイル 3 で別のシンボルに右クリック → **「Show Definition in Canvas」**

4. **複数ウィンドウの動作確認**

### 期待結果

| 項目              | 期待値                                         |
| ----------------- | ---------------------------------------------- |
| ウィンドウ追加    | 各操作でウィンドウが追加される（削除されない） |
| ドラッグ&ドロップ | 各ウィンドウが独立して移動できる               |
| リサイズ          | 各ウィンドウが独立してリサイズできる           |
| デバッグログ      | 各操作のログが連続出力される                   |

### ✅ テスト 5 成功条件

- [ ] 複数ウィンドウが同時に表示される
- [ ] ウィンドウが相互に干渉しない
- [ ] ドラッグ&リサイズが正常に動作する
- [ ] デバッグログが連続出力される

---

## テスト 6: エラーケース - エディタが選択されていない

**目的**: エディタがアクティブでない場合のエラーハンドリングを確認

### テスト手順

1. **キャンバスにフォーカスを移す**

   - Link Canvas ウィンドウをクリック

2. **右クリック** (キャンバス上で)

   - コンテキストメニューの「Show Definition in Canvas」が表示されるか確認

3. **別の方法: コマンドパレットから実行**
   - Cmd/Ctrl + Shift + P
   - "Show Definition in Canvas" を検索・実行

### 期待結果

| 項目                     | 期待値                                                                   |
| ------------------------ | ------------------------------------------------------------------------ |
| キャンバスでの右クリック | エディタコンテキストメニューは表示されない（キャンバス側のメニューのみ） |
| コマンドパレット実行     | エラーメッセージ「アクティブなエディタがありません」が表示される         |
| デバッグログ             | エラーハンドリングログが出力される                                       |

### ✅ テスト 6 成功条件

- [ ] キャンバス上では正しくメニューが表示されない
- [ ] コマンドパレットからの実行でエラーが適切に処理される
- [ ] ユーザーに分かりやすいメッセージが表示される

---

## テスト 7: ハイライト位置の正確性

**目的**: 定義/参照のハイライト位置が正確であることを確認

### テスト手順

1. **テストコード作成** (拡張ホスト VSCode で新規ファイル)

   ```typescript
   // test.ts
   export function myFunction(param: string) {
     return param.length;
   }

   const result = myFunction("hello");
   ```

2. **定義取得テスト**

   - 最後の行の`myFunction`に右クリック
   - **「Show Definition in Canvas」** 選択

3. **キャンバスで確認**

   - ハイライド行が「export function myFunction...」の行か確認

4. **参照取得テスト**

   - 同じく最後の行の`myFunction`に右クリック
   - **「Show References in Canvas」** 選択

5. **ハイライド位置を確認**
   - 定義ファイルと参照ファイルの両方が正しい行でハイライトされているか

### 期待結果

| ファイル     | ハイライド行                           |
| ------------ | -------------------------------------- |
| 定義ファイル | `export function myFunction(...)` の行 |
| 参照ファイル | `const result = myFunction(...)` の行  |

### ✅ テスト 7 成功条件

- [ ] 定義元の正確な行がハイライトされている
- [ ] 参照元の正確な行がハイライトされている
- [ ] ハイライト列位置も正確である

---

## デバッグコンソール 完全ログ例

### 正常系フロー全体

```
// 1. 定義取得コマンド実行
[Link Canvas] showDefinitionコマンド実行
[Link Canvas] 定義表示開始: /Users/user/project/src/extension.ts Position: 7 18
[Link Canvas] 定義ファイルをキャンバスに追加: FileTreeProvider.ts

// 2. 参照取得コマンド実行
[Link Canvas] showReferencesコマンド実行
[Link Canvas] 参照表示開始: /Users/user/project/src/extension.ts Position: 8 25
[Link Canvas] 参照ファイルをキャンバスに追加: CanvasViewProvider.ts
[Link Canvas] 参照ファイルをキャンバスに追加: extension.ts
[Link Canvas] 参照ファイルをキャンバスに追加: FileTreeProvider.ts
[Link Canvas] 参照数: 3

// 3. ズームレベル変更時のMonaco Editor表示
[Link Canvas] ズーム変更時にMonaco relayout: 1.50
[Link Canvas] Monaco layout() 実行完了 (0) ...
```

### エラー系ログ

```
// 定義なし
[Link Canvas] 定義表示開始: /Users/user/project/src/extension.ts Position: 0 0
// (ユーザーメッセージ: "定義が見つかりませんでした")

// ファイル読み込みエラー
[Link Canvas] 定義ファイル読み込みエラー: Error: ENOENT: no such file or directory
```

---

## 成功チェックリスト

### 機能チェック

- [ ] **コンテキストメニュー表示**

  - エディタ右クリックで「Show Definition in Canvas」が表示される
  - エディタ右クリックで「Show References in Canvas」が表示される

- [ ] **定義取得**

  - 定義ファイルがキャンバスに追加される
  - ハイライト行が正確である
  - 複数定義の場合、すべてが追加される

- [ ] **参照取得**

  - 参照ファイルがキャンバスに追加される
  - ハイライト行が正確である
  - 複数参照の場合、すべてが追加される

- [ ] **エラーハンドリング**

  - 定義なしの場合、ユーザーメッセージが表示される
  - エディタ非選択時、エラー通知が表示される

- [ ] **UI 統合**
  - ズームインで Monaco Editor が表示される
  - ハイライト情報が反映される
  - 複数ウィンドウが独立に動作する

### ログ・デバッグ

- [ ] デバッグコンソール に `[Link Canvas]` プリフィックス付きログが出力される
- [ ] エラー時はエラーログが出力される
- [ ] 予期しないエラーがない

### パフォーマンス

- [ ] 定義/参照取得時に UI がフリーズしない
- [ ] ハイライト表示が瞬時に反映される
- [ ] 複数ウィンドウでレンダリングが遅延しない

---

## トラブルシューティング

| 症状                                 | 原因                                | 解決方法                                     |
| ------------------------------------ | ----------------------------------- | -------------------------------------------- |
| コンテキストメニューが表示されない   | ビルドが古い                        | `npm run build` → F5 再実行                  |
| 「アクティブなエディタがありません」 | エディタにフォーカスがない          | エディタウィンドウをアクティブにしてから実行 |
| ファイルが追加されない               | VSCode 言語サーバーが起動していない | 拡張機能を確認し、言語ファイルを再度開く     |
| ハイライドが反映されない             | Webview 側の実装確認                | ブラウザコンソール確認（Webview Tools）      |
| エラー「その他」                     | 詳細不明                            | デバッグコンソール全体を確認、GutHub で報告  |

---

## テスト完了

すべてのテストが成功した場合、以下のステータスを確認：

```
✅ テスト1: 定義取得機能 - 完了
✅ テスト2: 参照取得機能 - 完了
✅ テスト3: エラーハンドリング - 完了
✅ テスト4: Monaco Editor表示 - 完了
✅ テスト5: 連続操作 - 完了
✅ テスト6: エラーケース - 完了
✅ テスト7: ハイライト位置精度 - 完了

🎉 すべてのテストが成功しました！
```

実装ブランチ `feat/vscode-context-menu-integration` は本番利用可能です。
